#!/bin/bash
# zmsdb-test - Automated testing script for zmsdb module

set -e

if [[ $1 == "--reset" ]]; then
    echo "ðŸ§¹ Resetting zmsdb test environment..."
    docker-compose down -v
    echo "âœ… Reset complete! All containers and volumes removed."
    exit 0
fi

PHPUNIT_ARGS=""
if [[ $# -gt 0 ]]; then
    PHPUNIT_ARGS="$*"
    echo "Running tests with arguments: $PHPUNIT_ARGS"
fi

if ! docker-compose ps mariadb | grep -q "Up"; then
    echo "Starting mariadb container..."
    docker-compose up -d mariadb
    echo "Waiting for mariadb to be ready..."
    until docker-compose exec -T mariadb mysqladmin ping -h localhost -u root -pzmsdb >/dev/null 2>&1; do
        sleep 2
    done
    echo "MariaDB is ready!"
else
    echo "MariaDB is already running"
fi

if ! docker-compose ps | grep -q "zmsdb"; then
    echo "Setting up test environment (first run)..."
    docker-compose down
    docker-compose up -d --build
    docker-compose logs -f test
else
    echo "Test environment already set up, running tests..."
    if [ -n "$PHPUNIT_ARGS" ]; then
        docker-compose run --rm --no-deps test bash -lc "\
apt update && apt install -y rsync && \
rsync -a --delete /host/ /tmp/workspace/ && \
cd /tmp/workspace/zmsdb && \
php -r 'require \"vendor/autoload.php\"; exit(class_exists(\"BO\\\\Zmsdldb\\\\FileAccess\")?0:42);' || \
(composer update eappointment/zmsdldb -W --no-progress --prefer-dist && composer dump-autoload -o) && \
php -d memory_limit=\${PHP_MEMORY_LIMIT:-1G} \
    -d auto_prepend_file=/tmp/workspace/zmsdb/vendor/autoload.php \
    bin/importTestData --commit && \
php -d memory_limit=\${PHP_MEMORY_LIMIT:-1G} \
    -d auto_prepend_file=/tmp/workspace/zmsdb/vendor/autoload.php \
    vendor/bin/phpunit $PHPUNIT_ARGS \
"
    else
        docker-compose run --rm --no-deps test bash -lc "\
apt update && apt install -y rsync && \
rsync -a --delete /host/ /tmp/workspace/ && \
cd /tmp/workspace/zmsdb && \
php -r 'require \"vendor/autoload.php\"; exit(class_exists(\"BO\\\\Zmsdldb\\\\FileAccess\")?0:42);' || \
(composer update eappointment/zmsdldb -W --no-progress --prefer-dist && composer dump-autoload -o) && \
php -d memory_limit=\${PHP_MEMORY_LIMIT:-1G} \
    -d auto_prepend_file=/tmp/workspace/zmsdb/vendor/autoload.php \
    bin/importTestData --commit && \
php -d memory_limit=\${PHP_MEMORY_LIMIT:-1G} \
    -d auto_prepend_file=/tmp/workspace/zmsdb/vendor/autoload.php \
    vendor/bin/phpunit \
"
    fi
fi
