#!/usr/bin/env bash
# Detect if script is being sourced (vs executed directly)
IS_SOURCED=false
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
  IS_SOURCED=true
fi

# Only set strict mode if not sourced (to avoid closing terminal on errors)
if [[ "$IS_SOURCED" == false ]]; then
  set -euo pipefail
else
  # When sourced, disable strict modes to prevent terminal from closing
  set +e  # Don't exit on error
  set +u  # Don't error on unset variables
  set +o pipefail  # Don't fail pipelines if any command in pipeline fails
fi

# Ensure podman remote client environment is set up (needed for WSL/Windows when sourcing)
if [[ -z "${XDG_RUNTIME_DIR:-}" ]] && [[ -d "/run/user/$(id -u)" ]]; then
  export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi
if [[ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]] && [[ -n "${XDG_RUNTIME_DIR:-}" ]]; then
  export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
fi

# Prefer podman-remote if available (works better in some WSL setups)
if command -v podman-remote >/dev/null 2>&1; then
  podman() {
    command podman-remote "$@"
  }
  export -f podman
fi

# zmsdb-test - Run zmsdb unit tests against local ddev or podman on a dedicated test DB
# Usage: ./zmsdb-test [PHPUnit arguments...]

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "ERROR: '$1' is required" >&2
    if [[ "$IS_SOURCED" == true ]]; then
      return 1
    else
      exit 1
    fi
  fi
}

info() { echo "[INFO] $*"; }
warn() { echo "[WARN] $*"; }
section() { echo ""; echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; echo "[SECTION] $*"; echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; echo ""; }

PHPUNIT_ARGS="${*:-}"
if [[ "$IS_SOURCED" == true ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_DB="zmsdb_test"

# Detect if we're using Podman or DDEV
section "1. Environment Detection"
USE_PODMAN=false
if command -v podman >/dev/null 2>&1; then
  if podman ps --format "{{.Names}}" | grep -q "^zms-web$" && podman ps --format "{{.Names}}" | grep -q "^zms-db$"; then
    USE_PODMAN=true
    info "Using Podman containers (zms-web, zms-db)"
  fi
fi

if [[ "$USE_PODMAN" == false ]]; then
  require_cmd ddev
  info "Using DDEV"
fi
echo ""

# Cleanup function to clear zmsapi/data folder (preserve .gitignore)
cleanup_data_folder() {
  if [[ "$USE_PODMAN" == true ]]; then
    (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc '
      if [ -d /var/www/html/zmsapi/data ]; then
        find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
        [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
      fi
    ' 2>/dev/null || true)
  else
    (cd "$PROJECT_ROOT" && ddev exec bash -lc '
      if [ -d /var/www/html/zmsapi/data ]; then
        find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
        [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
      fi
    ' 2>/dev/null || true)
  fi
}

# Set up EXIT trap to cleanup on script exit (normal, error, or Ctrl+C)
if [[ "$IS_SOURCED" == false ]]; then
  trap 'cleanup_data_folder' EXIT INT TERM
fi

# Ensure dedicated test database exists and grant access to 'db' user
section "2. Test Database Setup"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec -i zms-db mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS \`$TEST_DB\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; GRANT ALL PRIVILEGES ON \`$TEST_DB\`.* TO 'db'@'%'; FLUSH PRIVILEGES;" >/dev/null)
else
  (cd "$PROJECT_ROOT" && ddev mysql -e "CREATE DATABASE IF NOT EXISTS \`$TEST_DB\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; GRANT ALL PRIVILEGES ON \`$TEST_DB\`.* TO 'db'@'%'; FLUSH PRIVILEGES;" >/dev/null)
fi
info "Test database '$TEST_DB' ready"
echo ""

# Optional: clear caches using container's CACHE_DIR (and matching host path)
section "3. Cache Clearing"
if [[ "$USE_PODMAN" == true ]]; then
  CACHE_DIR=$(cd "$PROJECT_ROOT" && podman exec zms-web bash -lc 'echo "$CACHE_DIR"' 2>/dev/null || echo "")
else
  CACHE_DIR=$(cd "$PROJECT_ROOT" && ddev exec bash -lc 'echo "$CACHE_DIR"' 2>/dev/null || echo "")
fi

if [[ -n "$CACHE_DIR" ]]; then
  info "CACHE_DIR=$CACHE_DIR"
  for dir in zmsapi zmsdb zmscitizenapi; do
    if [[ "$USE_PODMAN" == true ]]; then
      (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc "
        if [ -d \"$CACHE_DIR/$dir\" ]; then
          rm -rf \"$CACHE_DIR/$dir\"/* \"$CACHE_DIR/$dir\"/.[!.]* \"$CACHE_DIR/$dir\"/..?* 2>/dev/null || true
          echo \"[CACHE] cleared $CACHE_DIR/$dir\"
        fi
      " || true)
    else
      (cd "$PROJECT_ROOT" && ddev exec bash -lc "
        if [ -d \"$CACHE_DIR/$dir\" ]; then
          rm -rf \"$CACHE_DIR/$dir\"/* \"$CACHE_DIR/$dir\"/.[!.]* \"$CACHE_DIR/$dir\"/..?* 2>/dev/null || true
          echo \"[CACHE] cleared $CACHE_DIR/$dir\"
        fi
      ")
    fi
  done
  HOST_CACHE_DIR="$CACHE_DIR"
  if [[ "$HOST_CACHE_DIR" == /var/www/html/* ]]; then
    HOST_CACHE_DIR="$PROJECT_ROOT${HOST_CACHE_DIR#/var/www/html}"
    if [[ -d "$HOST_CACHE_DIR" ]]; then
      rm -rf "$HOST_CACHE_DIR"/* "$HOST_CACHE_DIR"/.[!.]* "$HOST_CACHE_DIR"/..?* 2>/dev/null || true
      echo "[CACHE][host] cleared $HOST_CACHE_DIR"
    fi
    for dir in zmsapi zmsdb zmscitizenapi; do
      if [[ -d "$HOST_CACHE_DIR/$dir" ]]; then
        rm -rf "$HOST_CACHE_DIR/$dir"/* "$HOST_CACHE_DIR/$dir"/.[!.]* "$HOST_CACHE_DIR/$dir"/..?* 2>/dev/null || true
        echo "[CACHE][host] cleared $HOST_CACHE_DIR/$dir"
      fi
    done
  fi
else
  if [[ "$USE_PODMAN" == true ]]; then
    warn "CACHE_DIR not found in podman container"
  else
    warn "CACHE_DIR not found in ddev container"
  fi
fi
echo ""

# Setup fixtures like CI: materialize required fixture files into zmsapi/data (no symlink)
section "4. Fixture Setup"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc '
    set -e; echo "Setup fixtures...";
    mkdir -p /var/www/html/zmsapi/data;
    find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
    for f in services_de.json locations_de.json topic_de.json; do
      cp -f "/var/www/html/zmsdb/tests/Zmsdb/fixtures/$f" "/var/www/html/zmsapi/data/$f" 2>/dev/null || true;
    done;
    [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
  ')
else
  (cd "$PROJECT_ROOT" && ddev exec bash -lc '
    set -e; echo "Setup fixtures...";
    mkdir -p /var/www/html/zmsapi/data;
    find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
    for f in services_de.json locations_de.json topic_de.json; do
      cp -f "/var/www/html/zmsdb/tests/Zmsdb/fixtures/$f" "/var/www/html/zmsapi/data/$f" 2>/dev/null || true;
    done;
    [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
  ')
fi
echo ""

# Prepare and import test data, then run phpunit on the dedicated DB
section "5. Test Data Import & Running Tests"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; \
    cd /var/www/html/zmsdb; \
    php -r '\''require "vendor/autoload.php"; exit(class_exists("BO\\Zmsdldb\\FileAccess")?0:42);'\'' || (composer update eappointment/zmsdldb -W --no-progress --prefer-dist && composer dump-autoload -o); \
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsdb/vendor/autoload.php bin/importTestData --commit; \
    mysql -h db -uroot --ssl-mode=DISABLED -e '\''SET GLOBAL time_zone = "+00:00";'\'' || true; \
    mysql -h db -uroot --ssl-mode=DISABLED -e '\''SET time_zone = "+00:00";'\'' || true; \
    echo "[INFO] MariaDB time_zone set to +00:00 (UTC)"; \
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsdb/vendor/autoload.php vendor/bin/phpunit --no-coverage '"$PHPUNIT_ARGS" )
else
  (cd "$PROJECT_ROOT" && ddev exec bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; \
    cd /var/www/html/zmsdb; \
    php -r '\''require "vendor/autoload.php"; exit(class_exists("BO\\Zmsdldb\\FileAccess")?0:42);'\'' || (composer update eappointment/zmsdldb -W --no-progress --prefer-dist && composer dump-autoload -o); \
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsdb/vendor/autoload.php bin/importTestData --commit; \
    mysql -h db -uroot -e '\''SET GLOBAL time_zone = "+00:00";'\'' || true; \
    mysql -h db -uroot -e '\''SET time_zone = "+00:00";'\'' || true; \
    echo "[INFO] MariaDB time_zone set to +00:00 (UTC)"; \
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsdb/vendor/autoload.php vendor/bin/phpunit --no-coverage '"$PHPUNIT_ARGS" )
fi
echo ""

# Reset MariaDB timezone back to SYSTEM (global + session)
section "6. Database Timezone Reset"
RESET_SQL="SET GLOBAL time_zone = 'SYSTEM'; SET time_zone = 'SYSTEM';"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && printf "%s" "$RESET_SQL" | podman exec -i zms-db mysql -u root -proot >/dev/null 2>&1 || true)
else
  (cd "$PROJECT_ROOT" && printf "%s" "$RESET_SQL" | ddev mysql >/dev/null 2>&1 || true)
fi
echo ""

# Clean up zmsapi/data folder after tests (preserve .gitignore)
# Note: Cleanup also runs via EXIT trap on error or Ctrl+C
section "7. Cleanup"
info "Cleaning up zmsapi/data folder..."
cleanup_data_folder
info "Cleared zmsapi/data folder (preserved .gitignore)"
