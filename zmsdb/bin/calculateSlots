#!/usr/bin/env php
<?php
ini_set('memory_limit', '1024M');
require_once __DIR__ . '/script_bootstrap.php';

$scriptStart = microtime(true);

$dates = preg_grep('#^\d{4}-\d{1,2}-\d{1,2}#', $argv);
$now   = new \DateTimeImmutable();
if ($dates) {
    $now = new \DateTimeImmutable(array_shift($dates));
} elseif (class_exists('\App') && isset(\App::$now)) {
    $now = \App::$now;
}

$verbose  = (bool) preg_grep('#^--?v(erbose)?$#', $argv);
$delete   = (bool) preg_grep('#^--delete$#',   $argv);
$repair   = (bool) preg_grep('#^--repair$#',   $argv);
$calendar = (bool) preg_grep('#^--calendar$#', $argv);
$commit   = (bool) preg_grep('#^--commit$#',   $argv);

if ($commit) {
    echo "â³ Start Slot-Berechnung:  {$now->format('c')}\n";

    $calculator = new \BO\Zmsdb\Helper\CalculateSlots($verbose);

    try {
        $stepStart = microtime(true);
        $calculator->writeCalculations($now, $delete);
        echo "âœ… Slot-Berechnung fertig in "
            . round(microtime(true) - $stepStart, 2) . " s\n";

        if ($calendar) {
            echo "â³ BefÃ¼lle gesamtkalender â€¦\n";
            $stepStart = microtime(true);
            $populate  = new \BO\Zmsdb\Helper\PopulateOverallCalendar($verbose);
            $populate->writeCalendar($now);
            echo "âœ… Gesamtkalender fertig in "
                . round(microtime(true) - $stepStart, 2) . " s\n";
        }

        echo "ðŸ Gesamtlaufzeit: "
            . round(microtime(true) - $scriptStart, 2) . " s\n";

    } catch (\BO\Zmsdb\Exception\Pdo\LockTimeout $e) {
        echo "âŒ Lock-Timeout â€“ Logs folgen â€¦\n";
        $calculator->dumpLogs();
        error_log($e->getTraceAsString());
    } catch (\Exception $e) {
        echo "âŒ Abbruch â€“ Logs folgen â€¦\n";
        $calculator->dumpLogs();
        throw $e;
    }
    exit(0);
}


$dbname   = \BO\Zmsdb\Connection\Select::$writeSourceName;
$username = \BO\Zmsdb\Connection\Select::$username;

echo <<<USAGE
Usage: {$argv[0]} --commit [--calendar] [--verbose] [--delete] [--repair] [YYYY-MM-DD]

    Calculates/updates appointment slots (always) and â€“ with --calendar â€“
    additionally populates table "gesamtkalender" in 5-minute steps.

    --calendar   fill "gesamtkalender" after slot calculation
    --verbose    verbose output
    --delete     daily maintenance: delete old slots
    --repair     reserved
    YYYY-MM-DD   date to start calculation (default: today)

    Database:             {$dbname} as {$username}
    Date for calculation: {$now->format('c')}

USAGE;
