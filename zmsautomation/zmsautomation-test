#!/usr/bin/env bash
  set -euo pipefail

# Capture Maven arguments (e.g., -Dcucumber.filter.tags="@smoke" to run specific tags)
MAVEN_ARGS=("$@")

info() { echo "[INFO] $*"; }
warn() { echo "[WARN] $*"; }

SECTION_BAR="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
SECTION_COLOR_RESET=$'\033[0m'
SECTION_COLOR_INDEX=0
SECTION_COLORS=()
USE_SECTION_COLORS=false
if [[ -t 1 && -z "${NO_COLOR:-}" ]]; then
  SECTION_COLORS=(
    $'\033[38;5;196m' # red
    $'\033[38;5;208m' # orange
    $'\033[38;5;226m' # yellow
    $'\033[38;5;46m'  # green
    $'\033[38;5;51m'  # cyan
    $'\033[38;5;21m'  # blue
    $'\033[38;5;201m' # magenta
  )
  if [[ ${#SECTION_COLORS[@]} -gt 0 ]]; then
    USE_SECTION_COLORS=true
  fi
fi

section() {
  local title="$*"
  local prefix="" suffix=""
  if [[ "$USE_SECTION_COLORS" == true ]]; then
    prefix="${SECTION_COLORS[$SECTION_COLOR_INDEX]}"
    suffix="$SECTION_COLOR_RESET"
    SECTION_COLOR_INDEX=$(((SECTION_COLOR_INDEX + 1) % ${#SECTION_COLORS[@]}))
  fi
  echo ""
  echo "${prefix}${SECTION_BAR}${suffix}"
  echo "${prefix}[SECTION] $title${suffix}"
  echo "${prefix}${SECTION_BAR}${suffix}"
  echo ""
}

# Paths and variables
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Validate required environment variables
: "${MYSQL_PORT:?MYSQL_PORT must be set}"
: "${MYSQL_DATABASE:?MYSQL_DATABASE must be set}"
: "${MYSQL_USER:?MYSQL_USER must be set}"
: "${MYSQL_PASSWORD:?MYSQL_PASSWORD must be set}"
: "${CACHE_DIR:?CACHE_DIR must be set}"

DB_NAME="${MYSQL_DATABASE}"
DB_USER="${MYSQL_USER}"
DB_PASSWORD="${MYSQL_PASSWORD}"
DB_HOST="${MYSQL_HOST:-db}"  # Defaults to 'db' (docker-compose service name)
DB_PORT="${MYSQL_PORT##*:}"  # Extract port from "tcp://host:port" or just "port"

# File paths
BACKUP_FILE="/tmp/zms_backup_$(date +%s).sql.gz"
BASE_SQL_FILE="$PROJECT_ROOT/.resources/zms.sql"
FLYWAY_DIR="$PROJECT_ROOT/zmsautomation/src/main/resources/db/migration"

# API endpoints (for health checks from inside container)
BASE_URI="${BASE_URI:-http://localhost/terminvereinbarung/api/2}"
CITIZEN_API_BASE_URI="${CITIZEN_API_BASE_URI:-http://localhost/terminvereinbarung/api/citizen}"

# Cleanup function to clear zmsapi/data folder (preserve .gitignore)
cleanup_data_folder() {
  if [ -d "$PROJECT_ROOT/zmsapi/data" ]; then
    find "$PROJECT_ROOT/zmsapi/data" -mindepth 1 -not -name ".gitignore" -delete || warn "Failed to clean data folder"
    [ -f "$PROJECT_ROOT/zmsapi/data/.gitignore" ] || printf "*\n!.gitignore\n" > "$PROJECT_ROOT/zmsapi/data/.gitignore"
  fi
}

# Clear caches
clear_caches() {
  if [[ -n "${CACHE_DIR:-}" && -d "$CACHE_DIR" ]]; then
    info "Clearing caches in $CACHE_DIR..."
    find "$CACHE_DIR" -mindepth 1 -delete || warn "Failed to clear caches"
  else
    warn "CACHE_DIR not set or does not exist"
  fi
}

# Database helper function
exec_sql() {
  mysql --ssl=0 -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" --password="$DB_PASSWORD" "$DB_NAME" "$@"
}

exec_sql_root() {
  mysql --ssl=0 -h "$DB_HOST" -P "$DB_PORT" -u root --password="${MYSQL_ROOT_PASSWORD:-root}" "$@"
}

# Backup database
backup_db() {
  info "Backing up database to $BACKUP_FILE..."
  mysqldump --ssl=0 -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" --password="$DB_PASSWORD" "$DB_NAME" | gzip > "$BACKUP_FILE"
  info "Backup completed."
}

# Restore database
restore_db() {
  if [[ -f "$BACKUP_FILE" ]]; then
    info "Restoring database from $BACKUP_FILE..."
    gunzip < "$BACKUP_FILE" | exec_sql
    info "Database restored."
  else
    warn "No backup file found to restore."
  fi
}

# Drop all tables
drop_all_tables() {
  info "Dropping all existing tables..."
  local drop_sql="SET FOREIGN_KEY_CHECKS = 0;
SET @tables = (SELECT GROUP_CONCAT(CONCAT('\`', table_name, '\`')) FROM information_schema.tables WHERE table_schema = '$DB_NAME' AND table_type = 'BASE TABLE');
SET @sql = IF(@tables IS NULL OR @tables = '', 'DO 0', CONCAT('DROP TABLE IF EXISTS ', @tables));
PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
SET FOREIGN_KEY_CHECKS = 1;"
  echo "$drop_sql" | exec_sql
  info "Tables dropped."
}

# Ensure cleanup on exit
trap 'clear_caches; cleanup_data_folder' EXIT INT TERM
trap 'warn "Failure detected, attempting DB restore..."; restore_db' ERR

# 1. Database Backup
section "1. Database Backup"
backup_db

# 2. Cache Clearing
section "2. Cache Clearing"
clear_caches

# 3. Drop Tables
section "3. Database Tables Drop"
drop_all_tables

# Log database tables after reset
info "Database tables after reset (should be empty):"
exec_sql -e "SELECT table_name AS 'Table Name', table_rows AS 'Row Count' FROM information_schema.tables WHERE table_schema = '$DB_NAME' ORDER BY table_name;" || true

# 4. Import Base Database
section "4. Base Database Import"
if [[ -f "$BASE_SQL_FILE" ]]; then
  info "Importing base database from $BASE_SQL_FILE..."
  {
      echo "SET FOREIGN_KEY_CHECKS = 0;"
      cat "$BASE_SQL_FILE"
      echo "SET FOREIGN_KEY_CHECKS = 1;"
  } | exec_sql
  info "Base database import completed."
  
  info "Database tables after import:"
  exec_sql -e "SELECT table_name AS 'Table Name', table_rows AS 'Row Count' FROM information_schema.tables WHERE table_schema = '$DB_NAME' ORDER BY table_name;" || true
else
  warn "Base SQL file not found at $BASE_SQL_FILE, skipping import."
fi

# 5. Flyway Migrations
section "5. Flyway Migrations"
info "Clearing test data migrations from flyway_schema_history..."
exec_sql -e "DELETE FROM flyway_schema_history WHERE version > 1;" 2>/dev/null || true

info "Running Flyway migrations from $FLYWAY_DIR..."
flyway -url="jdbc:mariadb://$DB_HOST:$DB_PORT/$DB_NAME" -user="$DB_USER" -password="$DB_PASSWORD" \
  -locations="filesystem:$FLYWAY_DIR" -baselineOnMigrate=true migrate || warn "Flyway failed; continuing."

info "Database tables after Flyway:"
exec_sql -e "SELECT table_name AS 'Table Name', table_rows AS 'Row Count' FROM information_schema.tables WHERE table_schema = '$DB_NAME' ORDER BY table_name;" || true

# 6. PHP Migrations
section "6. PHP Migrations"
info "Running zmsapi PHP migrations..."
cd "$PROJECT_ROOT/zmsapi"
vendor/bin/migrate --update
info "PHP migrations completed."

info "Database tables after PHP migrations:"
exec_sql -e "SELECT table_name AS 'Table Name', table_rows AS 'Row Count' FROM information_schema.tables WHERE table_schema = '$DB_NAME' ORDER BY table_name;" || true

# 7. Hourly Cronjob
section "7. Hourly Cronjob"
info "Running hourly cron..."
if "$PROJECT_ROOT/zmsapi/cron/cronjob.hourly" --city=munich 2>/dev/null; then
  info "Hourly cron completed."
else
  warn "Hourly cron failed or not available; continuing."
fi

# 8. Health Checks
section "8. Health Checks"
info "Pinging citizenapi: $CITIZEN_API_BASE_URI/offices-and-services/"
if curl -sf --max-time 10 "$CITIZEN_API_BASE_URI/offices-and-services/" >/dev/null; then
    info "✓ citizenapi offices-and-services responding"
  else
    warn "✗ citizenapi offices-and-services NOT responding"
  fi

info "Pinging zmsapi: $BASE_URI/status/"
if curl -sf --max-time 10 "$BASE_URI/status/" >/dev/null; then
    info "✓ zmsapi status responding"
  else
    warn "✗ zmsapi status NOT responding"
  fi

# 9. Running Tests
section "9. Running ATAF Tests"
info "Running Cucumber/ATAF tests with -Pataf profile..."

# Clear old surefire reports and cucumber reports
rm -rf "$PROJECT_ROOT/zmsautomation/target/surefire-reports" 2>/dev/null || true
rm -rf "$PROJECT_ROOT/zmsautomation/target/cucumber.json" 2>/dev/null || true
rm -rf "$PROJECT_ROOT/zmsautomation/target/site/cucumber-pretty" 2>/dev/null || true

TEST_EXIT=0
cd "$PROJECT_ROOT/zmsautomation"

# Run with ATAF profile
if mvn -B -DtrimStackTrace=false \
  -Pataf \
  -Dbase.uri="$BASE_URI" \
  -Dcitizen.api.base.uri="$CITIZEN_API_BASE_URI" \
  test "${MAVEN_ARGS[@]+"${MAVEN_ARGS[@]}"}"; then
    TEST_EXIT=0
  else
    TEST_EXIT=$?
  fi

# 10. Test Results
section "10. Test Results"
info "Collecting surefire reports..."
if [[ -d "$PROJECT_ROOT/zmsautomation/target/surefire-reports" ]]; then
  ls -la "$PROJECT_ROOT/zmsautomation/target/surefire-reports"
  for f in "$PROJECT_ROOT/zmsautomation/target/surefire-reports"/*.txt; do
    if [[ -f "$f" ]]; then
      echo "==== $f ===="
      cat "$f"
      echo
    fi
  done
else
  info "No surefire-reports found"
fi

info "Cucumber reports available at:"
info "  - JSON: $PROJECT_ROOT/zmsautomation/target/cucumber.json"
info "  - HTML: $PROJECT_ROOT/zmsautomation/target/site/cucumber-pretty/index.html"

# 11. Final Cache Clearing
section "11. Final Cache Clearing"
clear_caches

# 12. Database Restore
section "12. Database Restore"
info "Restoring original database..."
restore_db

# Clear test data migrations from flyway_schema_history after restore
info "Clearing test data migrations from flyway_schema_history after restore..."
exec_sql -e "DELETE FROM flyway_schema_history WHERE version > 1;" 2>/dev/null || true

# 13. Cleanup
section "13. Cleanup"
info "Cleaning up zmsapi/data folder..."
cleanup_data_folder
info "Cleared zmsapi/data folder (preserved .gitignore)"

if [[ $TEST_EXIT -eq 0 ]]; then
  info "Tests completed successfully."
else
  warn "Tests failed (exit $TEST_EXIT)."
fi

  exit "$TEST_EXIT"
