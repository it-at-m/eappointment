#!/usr/bin/env bash
set -euo pipefail

# zmsclient-test - Run zmsclient unit tests using Docker or Podman
# Usage: ./zmsclient-test [PHPUnit arguments...]
# Note: This script restarts the containers to ensure clean state

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || { echo "ERROR: '$1' is required" >&2; exit 1; }
}

PHPUNIT_ARGS="${*:-}"
PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"
COMPOSE_CMD=""

# Performance optimization: disable Xdebug for faster tests (unless explicitly enabled)
ENABLE_XDEBUG="${ENABLE_XDEBUG:-false}"
if [[ "$ENABLE_XDEBUG" != "true" ]]; then
  export XDEBUG_MODE=off
fi

# Detect if we're using Podman or Docker
USE_PODMAN=false
if command -v podman >/dev/null 2>&1; then
  # Check if podman compose is available or if we should use docker compose with podman
  if command -v podman-compose >/dev/null 2>&1 || docker compose version >/dev/null 2>&1; then
    USE_PODMAN=true
    echo "[INFO] Using Podman"
  fi
fi

if [[ "$USE_PODMAN" == false ]]; then
  require_cmd docker
  # Check for docker compose v2 (space) or v1 (hyphen)
  if docker compose version >/dev/null 2>&1; then
    COMPOSE_CMD="docker compose"
  elif command -v docker-compose >/dev/null 2>&1; then
    COMPOSE_CMD="docker-compose"
  else
    echo "ERROR: docker compose or docker-compose is required" >&2
    exit 1
  fi
  echo "[INFO] Using Docker ($COMPOSE_CMD)"
fi

# Function to run compose commands
compose_cmd() {
  if [[ "$USE_PODMAN" == true ]]; then
    # Use podman compose if available, otherwise use docker compose with DOCKER_HOST
    if command -v podman-compose >/dev/null 2>&1; then
      podman-compose -f "$COMPOSE_FILE" "$@"
    else
      docker compose -f "$COMPOSE_FILE" "$@"
    fi
  else
    $COMPOSE_CMD -f "$COMPOSE_FILE" "$@"
  fi
}

# Function to get container name
get_test_container() {
  local container_name=""
  if [[ "$USE_PODMAN" == true ]]; then
    # Podman compose uses different naming conventions
    # Try common patterns: zmsclient_test_1, zmsclient-test-1, zmsclient-test, etc.
    container_name=$(podman ps --format "{{.Names}}" | grep -E "(zmsclient.*test|zmsclient-test)" | head -1 || echo "")
  else
    # Docker compose default naming: directory_service_index
    container_name=$(docker ps --format "{{.Names}}" | grep -E "(zmsclient.*test|zmsclient-test)" | head -1 || echo "")
  fi
  echo "$container_name"
}

# Function to run exec commands
exec_cmd() {
  local container="$1"
  shift
  if [[ "$USE_PODMAN" == true ]]; then
    podman exec "$container" "$@"
  else
    docker exec "$container" "$@"
  fi
}

echo "[INFO] Stopping and removing existing containers..."
compose_cmd down

echo "[INFO] Starting containers..."
if [[ "$ENABLE_XDEBUG" != "true" ]]; then
  echo "[INFO] Xdebug disabled for faster test execution (set ENABLE_XDEBUG=true to enable)"
fi
compose_cmd up -d

# Wait for containers to be ready
echo "[INFO] Waiting for containers to be ready..."
sleep 2

# Get the test container name
TEST_CONTAINER=$(get_test_container)
if [[ -z "$TEST_CONTAINER" ]]; then
  echo "[ERROR] Could not find test container. Available containers:"
  if [[ "$USE_PODMAN" == true ]]; then
    podman ps --format "{{.Names}}" || docker ps --format "{{.Names}}"
  else
    docker ps --format "{{.Names}}"
  fi
  echo ""
  echo "[INFO] Trying to find container by service name 'test'..."
  # Try alternative: look for any container with 'test' in the name from this project
  if [[ "$USE_PODMAN" == true ]]; then
    TEST_CONTAINER=$(podman ps --format "{{.Names}}" | grep -i "test" | head -1 || echo "")
  else
    TEST_CONTAINER=$(docker ps --format "{{.Names}}" | grep -i "test" | head -1 || echo "")
  fi
  if [[ -z "$TEST_CONTAINER" ]]; then
    echo "[ERROR] Still could not find test container. Please check container status."
    exit 1
  fi
  echo "[INFO] Using container: $TEST_CONTAINER"
fi

echo "[INFO] Found test container: $TEST_CONTAINER"

# Run PHPUnit tests
echo "[INFO] Running PHPUnit tests..."
if [[ -n "$PHPUNIT_ARGS" ]]; then
  exec_cmd "$TEST_CONTAINER" ./vendor/bin/phpunit "$PHPUNIT_ARGS"
else
  exec_cmd "$TEST_CONTAINER" ./vendor/bin/phpunit
fi

EXIT_CODE=$?

echo "[INFO] Tests completed with exit code: $EXIT_CODE"

# Cleanup: stop containers (optional, uncomment if you want to stop after tests)
# echo "[INFO] Stopping containers..."
# compose_cmd down

exit $EXIT_CODE

