#!/usr/bin/env bash
# Detect if script is being sourced (vs executed directly)
IS_SOURCED=false
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
  IS_SOURCED=true
fi

# Only set strict mode if not sourced (to avoid closing terminal on errors)
if [[ "$IS_SOURCED" == false ]]; then
set -euo pipefail
else
  # When sourced, disable strict modes to prevent terminal from closing
  set +e  # Don't exit on error
  set +u  # Don't error on unset variables
  set +o pipefail  # Don't fail pipelines if any command in pipeline fails
fi

# Ensure podman remote client environment is set up (needed for WSL/Windows when sourcing)
if [[ -z "${XDG_RUNTIME_DIR:-}" ]] && [[ -d "/run/user/$(id -u)" ]]; then
  export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi
if [[ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]] && [[ -n "${XDG_RUNTIME_DIR:-}" ]]; then
  export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
fi

# Prefer podman-remote if available (works better in some WSL setups)
if command -v podman-remote >/dev/null 2>&1; then
  podman() {
    command podman-remote "$@"
  }
  export -f podman
fi

# zmsapi-test - Run zmsapi unit tests against local ddev or podman on a dedicated test DB
# Usage: ./zmsapi-test [PHPUnit arguments...]

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "ERROR: '$1' is required" >&2
    if [[ "$IS_SOURCED" == true ]]; then
      return 1
    else
      exit 1
    fi
  fi
}

info() { echo "[INFO] $*"; }
warn() { echo "[WARN] $*"; }
section() { echo ""; echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; echo "[SECTION] $*"; echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"; echo ""; }

PHPUNIT_ARGS="${*:-}"
if [[ "$IS_SOURCED" == true ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
else
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
fi
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_DB="zmsapi_test"

# Detect if we're using Podman or DDEV
section "1. Environment Detection"
USE_PODMAN=false
if command -v podman >/dev/null 2>&1; then
  if podman ps --format "{{.Names}}" | grep -q "^zms-web$" && podman ps --format "{{.Names}}" | grep -q "^zms-db$"; then
    USE_PODMAN=true
    info "Using Podman containers (zms-web, zms-db)"
  fi
fi

if [[ "$USE_PODMAN" == false ]]; then
  require_cmd ddev
  info "Using DDEV"
fi
echo ""

# Cleanup function to clear zmsapi/data folder (preserve .gitignore)
cleanup_data_folder() {
if [[ "$USE_PODMAN" == true ]]; then
    (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc '
      if [ -d /var/www/html/zmsapi/data ]; then
        find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
        [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
      fi
    ' 2>/dev/null || true)
else
    (cd "$PROJECT_ROOT" && ddev exec bash -lc '
      if [ -d /var/www/html/zmsapi/data ]; then
        find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
        [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
      fi
    ' 2>/dev/null || true)
fi
}

# Function to clear application caches
clear_caches() {
  info "Clearing application caches (zmsapi, zmsdb, zmscitizenapi) using CACHE_DIR..."
  if [[ "$USE_PODMAN" == true ]]; then
    CACHE_DIR=$(cd "$PROJECT_ROOT" && podman exec zms-web bash -lc 'echo "$CACHE_DIR"' 2>/dev/null || echo "")
  else
    CACHE_DIR=$(cd "$PROJECT_ROOT" && ddev exec bash -lc 'echo "$CACHE_DIR"' 2>/dev/null || echo "")
  fi
  if [[ -n "$CACHE_DIR" ]]; then
    # Validate CACHE_DIR is absolute and sensible
    if [[ "$CACHE_DIR" != /* ]] || [[ "$CACHE_DIR" == *..* ]]; then
      warn "CACHE_DIR '$CACHE_DIR' looks suspicious, skipping cache clear"
      return
    fi
    info "CACHE_DIR=$CACHE_DIR"
    for dir in zmsapi zmsdb zmscitizenapi; do
      FULL_PATH="$CACHE_DIR/$dir"
      if [[ "$USE_PODMAN" == true ]]; then
        if (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc "
          if [ -d \"$FULL_PATH\" ]; then
            if find \"$FULL_PATH\" -mindepth 1 -delete 2>/dev/null; then
              echo \"[CACHE] cleared $FULL_PATH\"
            else
              echo \"[CACHE] failed to clear $FULL_PATH\" >&2
              exit 1
            fi
          fi
        "); then
          : # Success
        else
          warn "Failed to clear cache directory $FULL_PATH in container"
        fi
      else
        if (cd "$PROJECT_ROOT" && ddev exec bash -lc "
          if [ -d \"$FULL_PATH\" ]; then
            if find \"$FULL_PATH\" -mindepth 1 -delete 2>/dev/null; then
              echo \"[CACHE] cleared $FULL_PATH\"
            else
              echo \"[CACHE] failed to clear $FULL_PATH\" >&2
              exit 1
            fi
          fi
        "); then
          : # Success
        else
          warn "Failed to clear cache directory $FULL_PATH in container"
        fi
      fi
    done
    # Also clear host-side cache that corresponds to container path (\"/var/www/html\" maps to project root)
    HOST_CACHE_DIR="$CACHE_DIR"
    if [[ "$HOST_CACHE_DIR" == /var/www/html/* ]]; then
      HOST_CACHE_DIR="$PROJECT_ROOT${HOST_CACHE_DIR#/var/www/html}"
      # Validate host cache dir path
      if [[ "$HOST_CACHE_DIR" == *..* ]]; then
        warn "HOST_CACHE_DIR '$HOST_CACHE_DIR' looks suspicious, skipping host cache clear"
      elif [[ -d "$HOST_CACHE_DIR" ]]; then
        if find "$HOST_CACHE_DIR" -mindepth 1 -delete 2>/dev/null; then
          info "[CACHE][host] cleared $HOST_CACHE_DIR"
        else
          warn "[CACHE][host] failed to clear $HOST_CACHE_DIR"
        fi
      fi
      for dir in zmsapi zmsdb zmscitizenapi; do
        HOST_FULL_PATH="$HOST_CACHE_DIR/$dir"
        if [[ -d "$HOST_FULL_PATH" ]]; then
          if find "$HOST_FULL_PATH" -mindepth 1 -delete 2>/dev/null; then
            info "[CACHE][host] cleared $HOST_FULL_PATH"
          else
            warn "[CACHE][host] failed to clear $HOST_FULL_PATH"
          fi
        fi
      done
    fi
  else
    if [[ "$USE_PODMAN" == true ]]; then
      warn "CACHE_DIR not found in podman container"
    else
      warn "CACHE_DIR not found in ddev container"
    fi
  fi
}

# Function to reset timezone
reset_timezone() {
  RESET_SQL="SET GLOBAL time_zone = 'SYSTEM'; SET time_zone = 'SYSTEM';"
  if [[ "$USE_PODMAN" == true ]]; then
    if (cd "$PROJECT_ROOT" && printf "%s" "$RESET_SQL" | podman exec -i zms-db mysql -u root -proot 2>&1); then
      info "MariaDB timezone reset to SYSTEM"
    else
      warn "Failed to reset MariaDB timezone to SYSTEM"
    fi
  else
    if (cd "$PROJECT_ROOT" && printf "%s" "$RESET_SQL" | ddev mysql 2>&1); then
      info "MariaDB timezone reset to SYSTEM"
    else
      warn "Failed to reset MariaDB timezone to SYSTEM"
    fi
  fi
}

# Set up EXIT trap to cleanup on script exit (normal, error, or Ctrl+C)
if [[ "$IS_SOURCED" == false ]]; then
  trap 'reset_timezone; clear_caches; cleanup_data_folder' EXIT INT TERM
fi

# Ensure dedicated test database exists and grant access to 'db' user
section "2. Test Database Setup"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec -i zms-db mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS \`$TEST_DB\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; GRANT ALL PRIVILEGES ON \`$TEST_DB\`.* TO 'db'@'%'; FLUSH PRIVILEGES;")
else
  (cd "$PROJECT_ROOT" && ddev mysql -e "CREATE DATABASE IF NOT EXISTS \`$TEST_DB\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; GRANT ALL PRIVILEGES ON \`$TEST_DB\`.* TO 'db'@'%'; FLUSH PRIVILEGES;")
fi
info "Test database '$TEST_DB' ready"
echo ""

# Optional: clear caches using container's CACHE_DIR (and matching host path)
section "3. Cache Clearing"
clear_caches
echo ""

# Setup fixtures like CI: materialize required fixture files into zmsapi/data (no symlink)
section "4. Fixture Setup"
FIXTURE_SETUP_CMD='
  set -e; echo "Setup fixtures...";
  mkdir -p /var/www/html/zmsapi/data;
  find /var/www/html/zmsapi/data -mindepth 1 -not -name ".gitignore" -delete || true;
  for f in services_de.json locations_de.json topic_de.json; do
    cp -f "/var/www/html/zmsdb/tests/Zmsdb/fixtures/$f" "/var/www/html/zmsapi/data/$f" 2>/dev/null || true;
  done;
  [ -f /var/www/html/zmsapi/data/.gitignore ] || printf "*\n!.gitignore\n" > /var/www/html/zmsapi/data/.gitignore;
'
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc "$FIXTURE_SETUP_CMD")
else
  (cd "$PROJECT_ROOT" && ddev exec bash -lc "$FIXTURE_SETUP_CMD")
fi
echo ""

# Import test data with UTC timezone (base schema + fixtures + migrations)
section "5. Test Data Import"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsapi/vendor/autoload.php /var/www/html/zmsdb/bin/importTestData --commit')
else
  (cd "$PROJECT_ROOT" && ddev exec bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
    php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsapi/vendor/autoload.php /var/www/html/zmsdb/bin/importTestData --commit')
fi
echo ""

# Run PHPUnit with UTC timezone
section "6. Running Tests"
if [[ "$USE_PODMAN" == true ]]; then
  (cd "$PROJECT_ROOT" && podman exec zms-web bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
    if mysql -h db -uroot -e '\''SET GLOBAL time_zone = "+00:00";'\'' &&
       mysql -h db -uroot -e '\''SET time_zone = "+00:00";'\''; then
    echo "[INFO] MariaDB time_zone set to +00:00 (UTC)"; 
    else
      echo "[WARN] Failed to set MariaDB time_zone to +00:00" >&2;
    fi;
    export SKIP_DNS_VALIDATION=1; 
    cd /var/www/html/zmsapi && php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} vendor/bin/phpunit --no-coverage '"$PHPUNIT_ARGS" )
else
  (cd "$PROJECT_ROOT" && ddev exec bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
    export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
    if mysql -h db -uroot -e '\''SET GLOBAL time_zone = "+00:00";'\'' &&
       mysql -h db -uroot -e '\''SET time_zone = "+00:00";'\''; then
    echo "[INFO] MariaDB time_zone set to +00:00 (UTC)"; 
    else
      echo "[WARN] Failed to set MariaDB time_zone to +00:00" >&2;
    fi;
    export SKIP_DNS_VALIDATION=1; 
    cd /var/www/html/zmsapi && php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} vendor/bin/phpunit --no-coverage '"$PHPUNIT_ARGS" )
fi
echo ""

# Reset MariaDB timezone back to SYSTEM (global + session)
section "7. Database Timezone Reset"
reset_timezone
echo ""

# Clear caches after tests
section "8. Final Cache Clearing"
clear_caches
echo ""

# Clean up zmsapi/data folder after tests (preserve .gitignore)
# Note: Cleanup also runs via EXIT trap on error or Ctrl+C
section "9. Cleanup"
info "Cleaning up zmsapi/data folder..."
cleanup_data_folder
info "Cleared zmsapi/data folder (preserved .gitignore)"
