#!/usr/bin/env bash
set -euo pipefail

# zmsapi-test - Run zmsapi unit tests against local ddev on a dedicated test DB
# Usage: ./zmsapi-test [PHPUnit arguments...]

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || { echo "ERROR: '$1' is required" >&2; exit 1; }
}

require_cmd ddev

PHPUNIT_ARGS="${*:-}"
PROJECT_ROOT="$(cd "$(dirname "$0")"/.. && pwd)"
TEST_DB="zmsapi_test"

# Ensure dedicated test database exists and grant access to 'db' user
(cd "$PROJECT_ROOT" && ddev mysql -e "CREATE DATABASE IF NOT EXISTS \`$TEST_DB\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; GRANT ALL PRIVILEGES ON \`$TEST_DB\`.* TO 'db'@'%'; FLUSH PRIVILEGES;" >/dev/null)

# Optional: clear caches using container's CACHE_DIR (and matching host path)
CACHE_DIR=$(cd "$PROJECT_ROOT" && ddev exec bash -lc 'echo "$CACHE_DIR"' 2>/dev/null || echo "")
if [[ -n "$CACHE_DIR" ]]; then
  echo "[INFO] CACHE_DIR=$CACHE_DIR"
  for dir in zmsapi zmsdb zmscitizenapi; do
    (cd "$PROJECT_ROOT" && ddev exec bash -lc "
      if [ -d \"$CACHE_DIR/$dir\" ]; then
        rm -rf \"$CACHE_DIR/$dir\"/* \"$CACHE_DIR/$dir\"/.[!.]* \"$CACHE_DIR/$dir\"/..?* 2>/dev/null || true
        echo \"[CACHE] cleared $CACHE_DIR/$dir\"
      fi
    ")
  done
  HOST_CACHE_DIR="$CACHE_DIR"
  if [[ "$HOST_CACHE_DIR" == /var/www/html/* ]]; then
    HOST_CACHE_DIR="$PROJECT_ROOT${HOST_CACHE_DIR#/var/www/html}"
    if [[ -d "$HOST_CACHE_DIR" ]]; then
      rm -rf "$HOST_CACHE_DIR"/* "$HOST_CACHE_DIR"/.[!.]* "$HOST_CACHE_DIR"/..?* 2>/dev/null || true
      echo "[CACHE][host] cleared $HOST_CACHE_DIR"
    fi
    for dir in zmsapi zmsdb zmscitizenapi; do
      if [[ -d "$HOST_CACHE_DIR/$dir" ]]; then
        rm -rf "$HOST_CACHE_DIR/$dir"/* "$HOST_CACHE_DIR/$dir"/.[!.]* "$HOST_CACHE_DIR/$dir"/..?* 2>/dev/null || true
        echo "[CACHE][host] cleared $HOST_CACHE_DIR/$dir"
      fi
    done
  fi
else
  echo "[WARN] CACHE_DIR not found in ddev container"
fi

# Setup fixtures like CI: link zmsapi/data -> zmsdb fixtures
(cd "$PROJECT_ROOT" && ddev exec bash -lc 'echo "Setup fixtures..."; rm -rf /var/www/html/zmsapi/data && ln -s /var/www/html/zmsdb/tests/Zmsdb/fixtures /var/www/html/zmsapi/data')

# Import test data with UTC timezone (base schema + fixtures + migrations)
(cd "$PROJECT_ROOT" && ddev exec bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
  export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
  php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} -d auto_prepend_file=/var/www/html/zmsapi/vendor/autoload.php /var/www/html/zmsdb/bin/importTestData --commit')

# Run PHPUnit with UTC timezone
(cd "$PROJECT_ROOT" && ddev exec bash -lc 'set -e; set +u; '"export MYSQL_DATABASE=\"$TEST_DB\";"' \
  export TZ="UTC"; echo "[INFO] Using timezone: $TZ"; 
  mysql -h db -uroot -e '\''SET GLOBAL time_zone = "+00:00";'\'' || true; 
  mysql -h db -uroot -e '\''SET time_zone = "+00:00";'\'' || true; 
  echo "[INFO] MariaDB time_zone set to +00:00 (UTC)"; 
  export SKIP_DNS_VALIDATION=1; 
  cd /var/www/html/zmsapi && php -d date.timezone="UTC" -d memory_limit=${PHP_MEMORY_LIMIT:-1G} vendor/bin/phpunit --no-coverage '"$PHPUNIT_ARGS" )
