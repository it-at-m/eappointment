FROM php:8.3-apache

ENV TZ=Europe/Berlin
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# —————————————————————————————————————————
# 1. Build args & user
# —————————————————————————————————————————
ARG USERNAME=vscode
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd --gid $USER_GID $USERNAME \
 && useradd -m -u $USER_UID -g $USER_GID -s /bin/bash $USERNAME

# —————————————————————————————————————————
# 2. Install system deps & PHP extensions
# —————————————————————————————————————————
RUN apt-get update && apt-get install -y \
      git curl unzip make wget \
      libfreetype6-dev libjpeg62-turbo-dev libpng-dev \
      libicu-dev libonig-dev libzip-dev \
      python3-click python3-git python3-colorama \
      mariadb-client \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install intl gd pdo pdo_mysql zip calendar \
    && apt-get clean

# —————————————————————————————————————————
# 3. Enable Apache modules
# —————————————————————————————————————————
RUN a2enmod rewrite proxy_fcgi alias headers ssl

# —————————————————————————————————————————
# 4. Generate self-signed SSL certificate
# —————————————————————————————————————————
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/apache-selfsigned.key \
  -out /etc/ssl/certs/apache-selfsigned.crt \
  -subj "/C=DE/ST=Dev/L=Dev/O=Dev/OU=Dev/CN=localhost"

# —————————————————————————————————————————
# 5. Copy and enable SSL VirtualHost config
# —————————————————————————————————————————
COPY apache-ssl.conf /etc/apache2/sites-available/default-ssl.conf
RUN a2ensite default-ssl

# —————————————————————————————————————————
# 6. Install Node.js
# —————————————————————————————————————————
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
 && apt-get install -y nodejs

# —————————————————————————————————————————
# 7. Install Composer
# —————————————————————————————————————————
RUN curl -sS https://getcomposer.org/installer | php \
 && mv composer.phar /usr/local/bin/composer

# —————————————————————————————————————————
# 8. Install Java 17 (Eclipse Temurin) & Maven
# —————————————————————————————————————————
RUN apt-get update && apt-get install -y gnupg \
 && curl -fsSL https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor -o /usr/share/keyrings/adoptium.gpg \
 && echo "deb [signed-by=/usr/share/keyrings/adoptium.gpg] https://packages.adoptium.net/artifactory/deb $(. /etc/os-release && echo $VERSION_CODENAME) main" \
    > /etc/apt/sources.list.d/adoptium.list \
 && apt-get update && apt-get install -y temurin-17-jdk \
 && apt-get clean \
 && echo "export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-$(dpkg --print-architecture)" >> /etc/profile.d/java.sh \
 && echo 'export PATH="$JAVA_HOME/bin:$PATH"' >> /etc/profile.d/java.sh \
 && ln -sf /usr/lib/jvm/temurin-17-jdk-$(dpkg --print-architecture)/bin/java /usr/local/bin/java \
 && ln -sf /usr/lib/jvm/temurin-17-jdk-$(dpkg --print-architecture)/bin/javac /usr/local/bin/javac

RUN curl -fsSL https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz \
    | tar -xz -C /opt \
 && ln -s /opt/apache-maven-3.9.6/bin/mvn /usr/local/bin/mvn

# —————————————————————————————————————————
# 9. Install Flyway CLI
# —————————————————————————————————————————
RUN curl -fsSL https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.22.3/flyway-commandline-9.22.3-linux-x64.tar.gz \
    | tar -xz -C /opt \
 && ln -s /opt/flyway-9.22.3/flyway /usr/local/bin/flyway

# —————————————————————————————————————————
# 10. Set working directory & permissions
# —————————————————————————————————————————
WORKDIR /var/www/html

RUN chown -R www-data:www-data /var/www/html \
 && chmod -R 755 /var/www/html

# —————————————————————————————————————————
# 11. Expose
# —————————————————————————————————————————
EXPOSE 80

# Copy PHP overrides (upload limits etc.)
COPY php/uploads.ini /usr/local/etc/php/conf.d/uploads.ini
