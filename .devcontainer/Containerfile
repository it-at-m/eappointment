FROM ghcr.io/it-at-m/eappointment-php-base:8.3-dev

ENV TZ=Europe/Berlin
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# —————————————————————————————————————————
# 1. Build args & user (devcontainer-specific)
# —————————————————————————————————————————
ARG USERNAME=vscode
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd --gid $USER_GID $USERNAME \
 && useradd -m -u $USER_UID -g $USER_GID -s /bin/bash $USERNAME

# —————————————————————————————————————————
# 2. Install devcontainer-specific dependencies
# —————————————————————————————————————————
RUN apt-get update && apt-get install -y \
      python3-click python3-git python3-colorama \
      mariadb-client \
    && apt-get clean

# —————————————————————————————————————————
# 3. Generate self-signed SSL certificate (devcontainer-specific)
# —————————————————————————————————————————
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/apache-selfsigned.key \
  -out /etc/ssl/certs/apache-selfsigned.crt \
  -subj "/C=DE/ST=Dev/L=Dev/O=Dev/OU=Dev/CN=localhost"

# —————————————————————————————————————————
# 4. Copy and enable SSL VirtualHost config (devcontainer-specific)
# —————————————————————————————————————————
COPY apache-ssl.conf /etc/apache2/sites-available/default-ssl.conf
RUN mkdir -p /etc/apache2/sites-enabled && \
    ln -sf /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-enabled/default-ssl.conf

# —————————————————————————————————————————
# 5. Set working directory & permissions
# —————————————————————————————————————————
WORKDIR /var/www/html

RUN chown -R www-data:www-data /var/www/html \
 && chmod -R 755 /var/www/html

# —————————————————————————————————————————
# 6. Expose
# —————————————————————————————————————————
EXPOSE 80
