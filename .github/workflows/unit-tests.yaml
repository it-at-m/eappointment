name: unit tests

on:
  workflow_call:

env:
  XDEBUG_MODE: coverage

jobs:
  module-test:
    runs-on: ubuntu-latest
    container:
      image: "ghcr.io/it-at-m/eappointment-php-base:${{ matrix.php_version }}-dev"
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@main
      - name: Install Composer Dependencies
        run: |
          cd "${{ matrix.module }}"
          composer install --no-progress --prefer-dist --optimize-autoloader
      - name: Run Unit Tests with Coverage
        run: |
          cd "${{ matrix.module }}"
          mkdir -p coverage
          php -dzend_extension=xdebug.so -dmemory_limit=-1 ./vendor/bin/phpunit \
            --coverage-html coverage/html --coverage-clover coverage/clover.xml
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.module }}
          path: ${{ matrix.module }}/coverage/
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        include:
          - module: zmsadmin
            php_version: "8.0"
          - module: zmscalldisplay
            php_version: "8.0"
          - module: zmscitizenapi
            php_version: "8.0"
          - module: zmsdldb
            php_version: "8.0"
          - module: zmsentities
            php_version: "8.0"
          - module: zmsmessaging
            php_version: "8.0"
          - module: zmsslim
            php_version: "8.0"
          - module: zmsstatistic
            php_version: "8.0"
          - module: zmsticketprinter
            php_version: "8.0"

  zmsapi-test:
    runs-on: ubuntu-latest
    container:
      image: "ghcr.io/it-at-m/eappointment-php-base:8.0-dev"
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: zmsapi
          MYSQL_DATABASE: zmsbo
          MYSQL_CHARACTER_SET: utf8mb4
          MYSQL_COLLATION: utf8mb4_unicode_ci
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@main
      - name: Install python3
        run: |
          apt update
          apt install -y python3 python3-click python3-git
      - name: Referencing local Modules and Libraries
        run: python3 ./cli modules reference-libraries --no-symlink
      - name: Install Composer Dependencies
        run: |
          modules=('zmsapi' 'zmsdb')
          for module in "${modules[@]}"; do
            echo "Installing Composer dependencies for $module"
            (cd "$module" && composer install --no-progress --prefer-dist --optimize-autoloader)
          done
        shell: bash
      - name: Import Test Data and Run Unit Tests
        env:
          MYSQL_PORT: "tcp://mariadb:3306"
          MYSQL_DATABASE: zmsbo
          MYSQL_ROOT_PASSWORD: zmsapi
        run: |
          cd zmsapi
          echo "Setup fixtures..."
          rm -rf data
          ln -s vendor/eappointment/zmsdb/tests/Zmsdb/fixtures data
          echo "Importing test data..."
          vendor/bin/importTestData --commit
          mkdir -p coverage
          php -dzend_extension=xdebug.so -dmemory_limit=-1 vendor/bin/phpunit \
            --coverage-html coverage/html --coverage-clover coverage/clover.xml
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-zmsapi
          path: zmsapi/coverage/
          retention-days: 1

  zmsdb-test:
    runs-on: ubuntu-latest
    container:
      image: "ghcr.io/it-at-m/eappointment-php-base:8.0-dev"
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: zmsdb
          MYSQL_DATABASE: zmsbo
          MYSQL_CHARACTER_SET: utf8mb4
          MYSQL_COLLATION: utf8mb4_unicode_ci
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 5
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@main
      - name: Install python3
        run: |
          apt update
          apt install -y python3 python3-click python3-git
      - name: Referencing local Modules and Libraries
        run: python3 ./cli modules reference-libraries --no-symlink
      - name: Install Composer Dependencies
        run: |
          modules=('zmsdb')
          for module in "${modules[@]}"; do
            echo "Installing Composer dependencies for $module"
            (cd "$module" && composer install --no-progress --prefer-dist --optimize-autoloader)
          done
        shell: bash
      - name: Import Test Data and Run Unit Tests
        env:
          MYSQL_PORT: "tcp://mariadb:3306"
          MYSQL_DATABASE: zmsbo
          MYSQL_ROOT_PASSWORD: zmsdb
        run: |
          cd zmsdb
          bin/importTestData --commit
          mkdir -p coverage
          php -dzend_extension=xdebug.so -dmemory_limit=-1 vendor/bin/phpunit \
            --coverage-html coverage/html --coverage-clover coverage/clover.xml
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-zmsdb
          path: zmsdb/coverage/
          retention-days: 1

  zmsclient-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@main

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.0"
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: xdebug

      - name: Install Composer Dependencies
        run: |
          modules=('zmsclient')
          for module in "${modules[@]}"; do
            echo "Installing Composer dependencies for $module"
            (cd "$module" && composer install --no-progress --prefer-dist --optimize-autoloader)
          done

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Run Unit Tests
        run: |
          cd ./zmsclient
          mkdir -p coverage
          docker-compose up -d
          docker-compose exec -T test php -dzend_extension=xdebug.so -dmemory_limit=-1 \
            ./vendor/bin/phpunit --coverage-html coverage/html --coverage-clover coverage/clover.xml

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-zmsclient
          path: zmsclient/coverage/
          retention-days: 1

  combine-coverage:
    needs: [module-test, zmsapi-test, zmsdb-test, zmsclient-test]
    runs-on: ubuntu-latest
    steps:
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: all-coverage
          merge-multiple: true

      - name: Combine reports
        run: |
          mkdir -p combined-coverage
          for module in zmsadmin zmscalldisplay zmscitizenapi zmsdldb zmsentities zmsmessaging zmsslim zmsstatistic zmsticketprinter zmsapi zmsdb zmsclient; do
            if [ -d "all-coverage/coverage-$module" ]; then
              mkdir -p "combined-coverage/$module"
              cp -r "all-coverage/coverage-$module"/* "combined-coverage/$module/"
            fi
          done

      - name: Upload combined coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: combined-coverage/
          retention-days: 7