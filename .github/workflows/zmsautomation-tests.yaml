name: zmsautomation tests

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main, "feat-**", "fix-**" ]
  workflow_call:
    outputs:
      result:
        description: "ZMSAutomation test result"
        value: ${{ jobs.zmsautomation.outputs.result }}

jobs:
  zmsautomation:
    outputs:
      result: ${{ steps.set-result.outputs.result }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node (for Dev Containers CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dev Containers CLI
        run: |
          npm install -g @devcontainers/cli

      - name: Build and start dev containers
        run: |
          devcontainer up --workspace-folder .

      - name: Install Composer dependencies in container
        run: |
          docker exec zms-web bash -lc '
            set -e
            modules=("zmsapi" "zmsdb" "zmscitizenapi")
            for module in "${modules[@]}"; do
              echo "Installing Composer dependencies for $module"
              (cd "/var/www/html/$module" && composer install --no-progress --prefer-dist --optimize-autoloader)
            done
          '

      - name: Wait for services (zms-db)
        run: |
          for i in {1..60}; do
            if docker ps --format '{{.Names}}' | grep -q '^zms-db$'; then
              docker exec zms-db sh -lc 'mysqladmin ping -uroot -proot --silent' && break || true
            fi
            sleep 1
          done

      - name: Import test data (schema + base data)
        env:
          MYSQL_PORT: "tcp://db:3306"
          MYSQL_HOST: db
          MYSQL_DATABASE: db
          MYSQL_ROOT_PASSWORD: root
          MYSQL_USER: root
          MYSQL_PASSWORD: root
        run: |
          docker exec \
            -e MYSQL_PORT="$MYSQL_PORT" \
            -e MYSQL_HOST="$MYSQL_HOST" \
            -e MYSQL_DATABASE="$MYSQL_DATABASE" \
            -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
            -e MYSQL_USER="$MYSQL_USER" \
            -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
            zms-web bash -lc '
            set -e
            echo "Importing test data..."
            php -d date.timezone="UTC" -d memory_limit=1G \
              -d auto_prepend_file=/var/www/html/zmsapi/vendor/autoload.php \
              /var/www/html/zmsdb/bin/importTestData --commit
          '

      - name: Run Flyway test data migrations
        run: |
          NET=$(docker inspect -f '{{range $k,$v := .NetworkSettings.Networks}}{{printf "%s" $k}}{{end}}' zms-db)
          echo "Using network: $NET"
          docker run --rm \
            --network "$NET" \
            -v "$PWD/zmsautomation/flyway:/flyway/sql:ro" \
            docker.io/flyway/flyway:9 \
            -url=jdbc:mysql://db:3306/db -user=root -password=root \
            -locations=filesystem:/flyway/sql \
            -baselineOnMigrate=true \
            migrate || echo "Flyway failed; continuing."

      - name: Run zmsapi PHP migrations
        run: |
          docker exec zms-web bash -lc "cd zmsapi && vendor/bin/migrate --update"

      - name: Run hourly (best-effort, with logs)
        env:
          ZMS_CRONROOT: "1"
          ZMS_SOURCE_DLDB_MUNICH: "https://stadt.muenchen.de/service/info/zms/index/"
        run: |
          docker exec \
            -e ZMS_CRONROOT="$ZMS_CRONROOT" \
            -e ZMS_SOURCE_DLDB_MUNICH="$ZMS_SOURCE_DLDB_MUNICH" \
            zms-web bash -lc '
              set -e
              cd /var/www/html/zmsapi
              mkdir -p /var/www/html/zmsapi/var/log
              php -d date.timezone="UTC" -d memory_limit=1G cron/cronjob.hourly --city=munich 2>&1 | tee /var/www/html/zmsapi/var/log/cron.hourly.log || true
              echo "Hourly log saved to /var/www/html/zmsapi/var/log/cron.hourly.log"
            '

      - name: Health checks (with retry)
        run: |
          set -e
          for url in \
            "http://localhost:8090/terminvereinbarung/api/citizen/offices-and-services/" \
            "http://localhost:8090/terminvereinbarung/api/2/status/"; do
            echo "Waiting for $url"
            for i in {1..60}; do
              if curl -fsS --max-time 5 "$url" >/dev/null; then
                echo "OK: $url"
                break
              fi
              sleep 2
              if [ "$i" -eq 60 ]; then
                echo "ERROR: $url did not become ready in time" >&2
                exit 1
              fi
            done
          done

      - name: Run REST-assured tests
        run: |
          NET=$(docker inspect -f '{{range $k,$v := .NetworkSettings.Networks}}{{printf "%s" $k}}{{end}}' zms-web)
          docker volume create zmsautomation-cache >/dev/null 2>&1 || true
          docker run --rm \
            --network "$NET" \
            -e BASE_URI="http://zms-web/terminvereinbarung/api/2" \
            -e CITIZEN_API_BASE_URI="http://zms-web/terminvereinbarung/api/citizen" \
            -v "$PWD:/workspace" \
            -v "zmsautomation-cache:/root/.m2" \
            -w /workspace/zmsautomation \
            maven:3.9-eclipse-temurin-17 mvn -B -DtrimStackTrace=false test

      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            zmsautomation/target/surefire-reports/**

      - name: Set job result
        id: set-result
        if: always()
        run: echo "result=${{ job.status }}" >> $GITHUB_OUTPUT


