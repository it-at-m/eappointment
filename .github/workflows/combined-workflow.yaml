name: Combined Workflow

on: [push]

jobs:
  call-php-code-quality:
    uses: ./.github/workflows/php-code-quality.yaml

  call-php-unit-tests:
    uses: ./.github/workflows/php-unit-tests.yaml

  combine-php-test-coverage:
    needs: [call-php-unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: 'coverage-*'
          path: combined-coverage
          merge-multiple: false  # Keep separate directories

      - name: Upload combined coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: combined-coverage/
          retention-days: 7

  deploy-php-test-coverage:
    needs: combine-php-test-coverage
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download combined coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: coverage

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage

      - name: Deploy to GitHub Pages
        id: deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/deploy-pages@v4

  call-php-build-images:
    needs: [call-php-code-quality, call-php-unit-tests]
    if: |
      always() &&
      needs.call-php-code-quality.result == 'success' &&
      needs.call-php-unit-tests.result == 'success'
    uses: ./.github/workflows/php-build-images.yaml